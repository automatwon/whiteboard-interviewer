<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<script src="https://cdn.firebase.com/v0/firebase.js"></script>
<script src="codemirror/lib/codemirror.js"></script>
<script src="codemirror/mode/meta.js"></script>
<script id="langScript" src="codemirror/mode/clike/clike.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<link rel="stylesheet" href="codemirror/lib/codemirror.css" />
<script src="firepad.js"></script>
<link rel="stylesheet" href="firepad.css" />
<script src="example-helper.js"></script>

<style>
html { height: 100%; }
body { margin: 0; height: 100%; position: relative; background-color: #DDD; font-family:"Myriad pro", "Calibri", "Sans-serif";}
#editor-container{ width: 90%; margin:0 auto;}
.editor{ height:500px; }
</style>

</head>

<body>

<div style="margin:5px; text-align:center;">Language Mode : <select id='languages'></select></div>
<div id="editor-container"></div>

<script>

function initEditor(languageMode, languageMime, containerId){
  var scriptSrc = "codemirror/mode/" + languageMode + "/" + languageMode + ".js";
  $("#langScript").attr("src", scriptSrc);
  $.getScript(scriptSrc, function(){
    $("#" + containerId).html("");
    var room = "" + (window.location != window.parent.location) ? document.referrer: document.location;
    room = room.substring(room.indexOf('?'), room.indexOf('&'));
    var editorRef = new Firebase('https://whiteboard-interviewer.firebaseIO.com/editor/' + room);
    var codeMirror = CodeMirror(document.getElementById(containerId), {lineNumbers: true, mode: languageMime});
    var editor = Firepad.fromCodeMirror(editorRef, codeMirror);
  });
}

function langChanged(){
  var langId = $("#languages").val();
  var langMode = CodeMirror.modeInfo[langId].mode;
  var langMime = CodeMirror.modeInfo[langId].mime;
  initEditor(langMode, langMime, "editor-container");
  focusSelect(langMime);
}

function initSelect(){
    $.each(CodeMirror.modeInfo, function (index, value){
       $("#languages").append("<option id='lang" + index + "' value='" + index + "'> " + value.name + " </option>");
    });
    $("#languages").change(langChanged);
}

function focusSelect(languageMime){
    var active = 0;
    $.each(CodeMirror.modeInfo, function (index, value){ if(value.mime === languageMime) active = index; });
    $("#lang" + active).attr("selected", "selected");
}

$(document).ready(function(){
  CodeMirror.modeInfo.sort(function(a,b){
    var aName = a.name.toLowerCase();
    var bName = b.name.toLowerCase(); 
    return ((aName < bName) ? -1 : ((aName > bName) ? 1 : 0));
  });
  initSelect();
  focusSelect("text/x-java");
  initEditor("clike", "text/x-java", "editor-container" );
});

</script>

</body>

</html>
